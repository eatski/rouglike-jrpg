# ゲーム仕様書

Bevy 0.18製 2Dローグライク風JRPG

---

## 目次

1. [ゲーム概要](#ゲーム概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [キャラクター・パーティシステム](#キャラクターパーティシステム)
4. [戦闘システム](#戦闘システム)
5. [魔法システム](#魔法システム)
6. [敵モンスター](#敵モンスター)
7. [アイテム・装備](#アイテム装備)
8. [ワールドマップ](#ワールドマップ)
9. [洞窟ダンジョン](#洞窟ダンジョン)
10. [街システム](#街システム)
11. [ほこらシステム](#ほこらシステム)
12. [エンカウント](#エンカウント)
13. [シーン管理](#シーン管理)

---

## ゲーム概要

150×150のトーラス型（端がループする）手続き生成ワールドを探索するターン制JRPGです。勇者を中心に最大3人のパーティを編成し、世界各地の洞窟やほこらを巡りながら冒険します。

---

## アーキテクチャ

Cargoワークスペース構成で、以下の3層に分離されています。

### ドメイン層（Bevy非依存）

| クレート | 役割 |
|----------|------|
| `party` | キャラクター管理、ステータス、レベルアップ、インベントリ、装備 |
| `battle` | 戦闘システム、ダメージ計算、ターン実行 |
| `world` | ワールド探索、地形、マップ生成、移動ロジック |
| `cave` | 洞窟ダンジョン生成、宝箱、エンカウント |
| `town` | 街NPC、ショップ |
| `terrain` | 地形タイプ、タイル属性、移動ルール |
| `app-state` | ゲーム状態管理（シーン遷移、戦闘状態） |

### UI共通層

| クレート | 役割 |
|----------|------|
| `input-ui` | キーボード入力ヘルパー |
| `movement-ui` | 移動システム、スムーズ移動、バウンスエフェクト |

### UI機能層

| クレート | 役割 |
|----------|------|
| `world-ui` | ワールドマップ描画、カメラ、HUD、ミニマップ |
| `battle-ui` | 戦闘UI、メニュー、キャラクター表示、アニメーション |
| `town-ui` | 街メニュー、ショップ、NPC会話 |
| `cave-ui` | 洞窟探索UI、宝箱処理 |
| `hokora-ui` | ほこらUI |

### ツール群

| クレート | 役割 |
|----------|------|
| `generate-tiles` | マップタイルアセット生成 |
| `screenshot-*` | 各シーンのスクリーンショット撮影（battle, town, field, cave, world） |
| `deps-mermaid` | 依存関係図生成 |
| `merge-work` | ワークフロー管理 |

---

## キャラクター・パーティシステム

### パーティ構成

最大3人。初期状態は勇者1人でスタートし、街でNPCに話しかけることで仲間を勧誘できます。

### 職業とステータス

| 職業 | HP | MP | ATK | DEF | SPD | 成長(HP/MP/ATK/DEF/SPD) |
|------|----|----|-----|-----|-----|-------------------------|
| 勇者（Hero） | 30 | 5 | 8 | 3 | 5 | +5/+1/+2/+1/+1 |
| 魔法使い（Mage） | 20 | 15 | 10 | 2 | 7 | +3/+3/+2/+1/+1 |
| 僧侶（Priest） | 25 | 12 | 5 | 4 | 4 | +4/+2/+1/+1/+1 |

### レベルアップ

- **必要経験値**: `レベル² × 5 + レベル × 5`
  - Lv1→2: 10 EXP
  - Lv2→3: 30 EXP
  - Lv3→4: 60 EXP
- レベルアップ時にHP/MPが全回復

### 仲間勧誘システム

3段階の勧誘状態があります。

1. **未発見**（Undiscovered）→ 初回会話で **知り合い**（Acquaintance）に
2. **知り合い** → 別の街での再会話で **加入**（Recruited）

勧誘候補はスポーン島の異なる街に配置されます。

### 初期状態

- パーティ: 勇者1人
- 所持品: ハーブ ×2
- ゴールド: 100G

---

## 戦闘システム

### 戦闘フロー

1. ランダムエンカウントで敵グループ生成
2. パーティの行動選択（攻撃/魔法/アイテム/逃走）
3. SPD順でターン実行（同速の場合、味方優先）
4. 敵全滅で勝利 → EXP獲得
5. 味方全滅で敗北
6. 逃走成功で戦闘終了

### 行動タイプ

| 行動 | 説明 |
|------|------|
| 攻撃（Attack） | 対象の敵に物理攻撃 |
| 魔法（Spell） | MPを消費して魔法を使用 |
| アイテム（UseItem） | インベントリのアイテムを使用 |
| 逃走（Flee） | 50%の確率で戦闘から逃走 |

### ダメージ計算

- **物理攻撃**: `(攻撃力 - 防御力/2) × 乱数(0.8〜1.2)` ※最低1
- **魔法攻撃**: `(魔法威力 - 防御力/4) × 乱数(0.8〜1.2)` ※最低1
- **回復魔法**: `魔法威力 × 乱数(0.8〜1.2)` ※最低1

### リターゲット

- 対象の敵が倒された場合、生存している最初の敵に自動変更
- 対象の味方が倒された場合、生存している最初の味方に自動変更

---

## 魔法システム

| 魔法名 | タイプ | MP消費 | 威力 | 習得者 |
|--------|--------|--------|------|--------|
| ファイア（Fire） | 攻撃 | 3 | 12 | 魔法使い（Lv1） |
| ブレイズ（Blaze） | 攻撃 | 7 | 25 | 魔法使い（Lv5） |
| ヒール（Heal） | 回復 | 4 | 15 | 勇者（Lv3）、僧侶（Lv1） |
| フルヒール（FullHeal） | 回復 | 8 | 40 | 僧侶（Lv4） |

---

## 敵モンスター

### 種類と能力値

| 敵名 | HP | ATK | DEF | SPD | 獲得EXP |
|------|----|----|-----|-----|---------|
| スライム | 10 | 3 | 1 | 3 | 3 |
| コウモリ | 8 | 4 | 0 | 6 | 4 |
| ゴブリン | 15 | 5 | 2 | 3 | 6 |
| おおかみ | 12 | 7 | 1 | 5 | 8 |
| ゴースト | 20 | 4 | 3 | 2 | 10 |

### 敵グループ生成

- 同一種類の敵1〜4体で出現
  - 1体: 30%
  - 2体: 30%
  - 3体: 25%
  - 4体: 15%

### 敵AI

生存している最初のパーティメンバーに物理攻撃を行います。

---

## アイテム・装備

### インベントリ

- 最大6スロット
- 装備スロット: 武器のみ

### 消費アイテム

| アイテム | 効果 | 購入価格 | 売却価格 |
|----------|------|----------|----------|
| ハーブ | HP 25回復 | 8G | 4G |
| ハイハーブ | HP 50回復 | 24G | 12G |

### キーアイテム

| アイテム | 用途 | 売却 |
|----------|------|------|
| 銅の鍵 | 扉の解錠 | 不可 |

### 素材アイテム

| アイテム | 売却価格 |
|----------|----------|
| 魔法石 | 30G |
| 銀鉱石 | 60G |
| 古代のコイン | 120G |
| 竜のウロコ | 250G |

### 武器

| 武器名 | ATKボーナス | 購入価格 | ショップ販売 |
|--------|-----------|----------|------------|
| 木の剣 | +2 | 10G | あり |
| 鉄の剣 | +5 | 50G | あり |
| 鋼の剣 | +10 | 150G | なし |
| 魔法の杖 | +3 | 30G | あり |
| 聖なる杖 | +4 | 80G | なし |

**実効攻撃力** = 基礎ATK + 装備ボーナス

---

## ワールドマップ

### 基本パラメータ

- サイズ: **150×150** タイル
- トポロジー: **トーラス**（上下左右がループ）
- 移動: **4方向**（上下左右のみ）

### 地形タイプ

| 地形 | 歩行可能 | エンカウント率 | 特殊効果 |
|------|----------|---------------|----------|
| 平原 | ○ | 2% | なし |
| 森 | ○ | 3% | なし |
| 山 | × | - | 通行不可 |
| 海 | △（船のみ） | 10% | 船で航行 |
| 街 | ○ | 0% | 街に入る |
| 洞窟 | ○ | 0% | 洞窟に入る |
| ほこら | ○ | 0% | ほこらに入る |

### 手続き生成アルゴリズム

5フェーズで生成されます。

#### フェーズ1: 大陸配置
- 大陸5つ（大2 + 小3）
- 大陸目標サイズ: 大 3500タイル / 小 2000タイル
- 最小大陸間距離: 30タイル（トーラス距離）
- メイン大陸は座標(75-90, 75-90)付近

#### フェーズ2: 大陸拡張
- フロンティア拡散アルゴリズム（拡散確率65%）
- 大陸間に4タイルのバッファを確保
- 浸食防止: 最も近い大陸にのみ拡散

#### フェーズ2.5a: 海岸線浸食
- 2パスの浸食で入り江と湾を生成
- 海に隣接するタイルが浸食される確率:
  - 海2面以上: 30%
  - 海3面以上: 60%

#### フェーズ2.5b: 湖の生成
- 60箇所の湖クラスター
- 湖サイズ: 8〜60タイル

#### フェーズ2.5c: 極小島の除去
- 8タイル未満の島は海に変換（スポーン島を除く）

#### フェーズ3: 地形クラスター
- 森: 45クラスター（各20〜80タイル）
- 山: 60クラスター（各15〜50タイル）
- スポーン地点は平原として保護

#### フェーズ4: 拠点配置
- 大きな島（2500+タイル）: 街5つ
- 小さな島: 街3つ
- 街の最小間隔: 10タイル
- 街の配置に必要な島の最小サイズ: 100タイル
- 洞窟: 島あたり最大2つ

#### フェーズ5: 接続性保証
- 山による分断を検出し、山タイルを平原に変換してパスを作成
- すべての歩行可能エリアが接続されていることを保証

### 船システム

- 各島に1隻の船が配置される
- 海に隣接する位置に配置
- 船に乗ると海を航行可能
- 海岸に到達すると下船

### 視界システム

- 視界半径: 9×9タイル
- 3つの状態: 未探索（Unexplored）/ 探索済（Explored）/ 可視（Visible）

---

## 洞窟ダンジョン

### 基本パラメータ

- サイズ: **30×30** タイル
- 生成: ランダムウォーク（400ステップ）
- 入口: 中央(15, 15)にはしご配置

### 地形

| 地形 | 歩行可能 | エンカウント率 |
|------|----------|---------------|
| 洞窟床 | ○ | 5% |
| 洞窟壁 | × | - |
| はしご | ○ | 0%（出口） |

### 宝箱

- 洞窟あたり最大3つ（1〜3個ランダム）
- 洞窟床にランダム配置
- 開封済みの宝箱は永続的に記録

#### 宝箱の中身（重み付き抽選）

| アイテム | 重み |
|----------|------|
| ハーブ | 25 |
| 魔法石 | 25 |
| ハイハーブ | 15 |
| 銀鉱石 | 15 |
| 古代のコイン | 10 |
| 銅の鍵 | 5 |
| 竜のウロコ | 3 |
| 木の剣 | 2 |

---

## 街システム

### ショップ

#### 購入可能アイテム
- ハーブ（8G）
- ハイハーブ（24G）

#### 購入可能武器
- 木の剣（10G）
- 鉄の剣（50G）
- 魔法の杖（30G）

#### 売却
- 消費アイテム: 購入価格の50%
- 素材: 固定価格（30〜250G）
- キーアイテム: 売却不可

### 宿屋

パーティ全員のHP/MPが全回復（無料）

### NPC会話

- 一般NPC: 魔王の城の位置へのヒント
- 方角NPCは最寄りの洞窟/ほこらへの方角と距離を案内
  - 距離15以内: 「すぐ ちかくの」
  - 距離15〜40: 「すこし あるいた さきの」
  - 距離40以上: 「はるか とおくの」
- 方角はトーラス距離で計算

---

## ほこらシステム

- 大きな大陸（最初の2大陸）に各1つ配置
- 平原上に設置
- 合計2箇所

---

## エンカウント

移動時に地形ごとのエンカウント率で判定されます。

| 地形 | エンカウント率 |
|------|---------------|
| 平原 | 2% |
| 森 | 3% |
| 洞窟床 | 5% |
| 山 | 8% |
| 海 | 10% |
| 街/洞窟入口/ほこら/はしご | 0% |

---

## シーン管理

### シーン状態（SceneState）

| 状態 | 説明 |
|------|------|
| Exploring | ワールドマップ探索中 |
| Town | 街の中 |
| Cave | 洞窟の中 |
| Hokora | ほこらの中 |

### 戦闘状態（BattleState）

| 状態 | 説明 |
|------|------|
| None | 非戦闘時 |
| Active | 戦闘中 |

### 計算状態（InField）

`Exploring` または `Cave` でかつ `BattleState::None` のとき、フィールド移動が有効になります。

---

## 移動システム

### 特徴

- 4方向移動（上下左右のみ、斜め不可）
- スムーズ移動アニメーション（ease-out-quad）
- 移動アニメーション中は入力ロック
- バウンスエフェクト

### イベント

| イベント | 発火タイミング |
|----------|--------------|
| PlayerMovedEvent | プレイヤーが移動したとき |
| MovementBlockedEvent | 通行不可タイルへの移動試行時 |
| TileEnteredEvent | 新しいタイルに入ったとき |

---

## 永続データ

以下のデータが画面遷移をまたいで保持されます。

- パーティメンバーのHP/MP/レベル/EXP
- 所持ゴールド
- インベントリ（アイテム・装備）
- 開封済み宝箱の記録（ワールド座標+洞窟座標）
- 仲間の勧誘状態
- マップ探索状態（視界の記録）
