#!/bin/bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# worktreeブランチ一覧を取得（main以外）
branches=()
while IFS= read -r line; do
    branch=$(echo "$line" | sed 's/.*\[//;s/\]$//')
    worktree=$(echo "$line" | awk '{print $1}')
    if [ "$branch" != "main" ]; then
        branches+=("$branch")
    fi
done < <(git -C "$REPO_ROOT" worktree list | tail -n +2)

if [ ${#branches[@]} -eq 0 ]; then
    echo "作業中のworktreeブランチがありません" >&2
    exit 1
fi

# ブランチ選択
echo "マージするブランチを選択してください:"
for i in "${!branches[@]}"; do
    echo "  $((i+1))) ${branches[$i]}"
done
printf "> "
read -r choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#branches[@]} ]; then
    echo "無効な選択です" >&2
    exit 1
fi

selected="${branches[$((choice-1))]}"
echo ""
echo "ブランチ '$selected' をmainにマージします..."

cd "$REPO_ROOT"

# mainブランチにいることを確認
current=$(git branch --show-current)
if [ "$current" != "main" ]; then
    echo "mainブランチに切り替えます..."
    git checkout main
fi

# マージ実行
if git merge --no-edit "$selected"; then
    echo ""
    echo "マージ成功: $selected -> main"
else
    echo ""
    echo "コンフリクトが発生しました。Claude Codeでコンフリクト解消を開始します..."
    echo ""

    # コンフリクトファイル一覧
    conflict_files=$(git diff --name-only --diff-filter=U)
    echo "コンフリクトファイル:"
    echo "$conflict_files" | sed 's/^/  /'
    echo ""

    # Claude Codeをインタラクティブモードで起動してコンフリクト解消
    claude "git mergeでコンフリクトが発生しました。以下のファイルのコンフリクトを解消してください。コンフリクトマーカー（<<<<<<< ======= >>>>>>>）を確認し、両方の変更を適切に統合してください。解消後、git addして git commit --no-edit してください。

コンフリクトファイル:
$conflict_files"
fi
